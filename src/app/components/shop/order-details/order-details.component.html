<app-breadcrumb [breadcrumb]="breadcrumb"></app-breadcrumb>

<section class="user-dashboard-section">
    <div class="container-fluid-lg">
        <div class="row">
            <div class="col-12">
                <div class="dashboard-right-sidebar" *ngIf="order">
                    <!-- 1. Header -->
                    <div class="title-header mb-4">
                        <div class="d-flex align-items-center justify-content-between">
                            <h5>{{ 'Order' | translate }} #{{ order.order_number }}</h5>
                        </div>
                    </div>

                    <!-- 2. Tracking Bar -->
                    <div class="tracking-panel mb-5">
                        <ul *ngIf="order && !order?.sub_orders?.length">
                            <ng-container *ngFor="let orderStatus of (orderStatus$ | async)?.data">
                                <li [class.active]="orderStatus?.sequence! <= order.order_status.sequence!" [ngClass]="{
                                        'd-none': (orderStatus?.sequence! >= order.order_status.sequence! 
                                        && (order.order_status && order.order_status.slug == 'cancelled')) ||
                                        orderStatus?.slug == 'cancelled' || (order.is_digital_only && (orderStatus?.slug == 'shipped' || orderStatus?.slug == 'out-for-delivery'))
                                    }">
                                    <div class="panel-content">
                                        <div class="icon">
                                            <img src="assets/svg/tracking/{{orderStatus?.slug}}.svg" class="img-fluid"
                                                alt="tracking icon">
                                        </div>
                                        <div class="status">{{ orderStatus?.name?.replaceAll('_', ' ') | titlecase }}
                                        </div>
                                    </div>
                                </li>
                            </ng-container>

                            <!-- Cancelled Case -->
                            <li class="active" *ngIf="order?.order_status && order?.order_status?.slug == 'cancelled'">
                                <div class="panel-content">
                                    <div class="icon" style="background: #fee2e2; border-color: #fee2e2;">
                                        <img src="assets/svg/tracking/{{order.order_status.slug}}.svg" class="img-fluid"
                                            alt="cancelled icon">
                                    </div>
                                    <div class="status" style="color: #991b1b;">{{ 'Cancelled' | translate }}</div>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <!-- 3. Product List Card -->
                    <div class="card mb-4" *ngIf="order?.products?.length">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table product-table mb-0">
                                    <thead>
                                        <tr>
                                            <th scope="col">{{ 'Item' | translate }}</th>
                                            <th scope="col">{{ 'Description' | translate }}</th>
                                            <th scope="col">{{ 'Price' | translate }}</th>
                                            <th scope="col">{{ 'Qty' | translate }}</th>
                                            <th scope="col" class="text-end pe-4">{{ 'Subtotal' | translate }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let product of order.products">
                                            <td class="product-image ps-4">
                                                <img [src]="product?.pivot?.variation && product?.pivot?.variation?.variation_image
                                                        ? product?.pivot?.variation?.variation_image?.original_url
                                                        : product?.product_thumbnail
                                                        ? product?.product_thumbnail?.original_url
                                                        : 'assets/images/product.png'" class="img-fluid" alt="product">
                                            </td>
                                            <td>
                                                <h6>{{ product?.pivot?.variation ? product?.pivot?.variation?.name :
                                                    product?.name }}</h6>
                                            </td>
                                            <td>
                                                <h6>{{ product?.pivot?.single_price | currencySymbol }}</h6>
                                            </td>
                                            <td>
                                                <h6>{{ product?.pivot?.quantity }}</h6>
                                            </td>
                                            <td class="text-end pe-4">
                                                <h6>{{ product?.pivot?.subtotal | currencySymbol }}</h6>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Details & Summary -->
                    <div class="row">
                        <!-- Customer Details -->
                        <div class="col-xxl-8 col-lg-7">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h3 class="fw-semibold mb-4">{{ 'Shipping & Payment' | translate }}</h3>
                                    <div class="customer-detail">
                                        <div class="row g-4">
                                            <div class="col-sm-6" *ngIf="order?.billing_address">
                                                <label>{{ 'Billing Info' | translate }}</label>
                                                <h4>
                                                    {{ order.billing_address.street }}<br>
                                                    {{ order.billing_address.city }}, {{
                                                    getStateName(order.billing_address.state_id) }}<br>
                                                    {{ getCountryName(order.billing_address.country_id) }} - {{
                                                    order.billing_address.pincode }}<br>
                                                    <span style="color: #94a3b8; font-size: 13px;">T: {{
                                                        order.billing_address.country_code }} {{
                                                        order.billing_address.phone }}</span>
                                                </h4>
                                            </div>
                                            <div class="col-sm-6"
                                                *ngIf="order?.shipping_address && !order?.is_digital_only">
                                                <label>{{ 'Shipping Info' | translate }}</label>
                                                <h4>
                                                    {{ order.shipping_address.street }}<br>
                                                    {{ order.shipping_address.city }}, {{
                                                    getStateName(order.shipping_address.state_id) }}<br>
                                                    {{ getCountryName(order.shipping_address.country_id) }} - {{
                                                    order.shipping_address.pincode }}<br>
                                                    <span style="color: #94a3b8; font-size: 13px;">T: {{
                                                        order.shipping_address.country_code }} {{
                                                        order.shipping_address.phone }}</span>
                                                </h4>
                                            </div>
                                            <div class="col-sm-4" *ngIf="order?.payment_method">
                                                <label>{{ 'Payment Method' | translate }}</label>
                                                <div class="d-flex align-items-center gap-2">
                                                    <h4>{{ (order?.payment_method === 'RaylomShop_nabu' ? 'UPI / Online
                                                        Payment' : order.payment_method) | uppercase }}</h4>
                                                </div>
                                            </div>
                                            <div class="col-sm-4" *ngIf="order?.payment_status">
                                                <label>{{ 'Payment Status' | translate }}</label>
                                                <div class="d-flex align-items-center gap-2">
                                                    <h4
                                                        [style.color]="order.payment_status === 'paid' ? '#059669' : '#000'">
                                                        {{ order.payment_status | uppercase }}</h4>
                                                </div>
                                            </div>
                                            <div class="col-sm-4"
                                                *ngIf="order?.delivery_description && !order?.is_digital_only">
                                                <label>{{ 'Delivery Preference' | translate }}</label>
                                                <h4>{{ order.delivery_description }}</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Summary -->
                        <div class="col-xxl-4 col-lg-5">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h3 class="fw-semibold mb-4">{{ 'Summary' | translate }}</h3>
                                    <div class="tracking-total">
                                        <ul>
                                            <li>{{ 'Subtotal' | translate }} <span>{{ (order.amount ? order.amount : 0)
                                                    | currencySymbol }}</span></li>
                                            <li *ngIf="!order?.is_digital_only">{{ 'Shipping Fee' | translate }}
                                                <span>{{ (order.shipping_total ? order.shipping_total : 0) |
                                                    currencySymbol }}</span>
                                            </li>
                                            <li>{{ 'Tax' | translate }} <span>{{ (order.tax_total ? order.tax_total : 0)
                                                    | currencySymbol }}</span></li>

                                            <li class="txt-primary" *ngIf="order.points_amount != 0">{{ 'Points Used' |
                                                translate }} <span>-{{ order.points_amount | currencySymbol }}</span>
                                            </li>
                                            <li class="txt-primary" *ngIf="order.wallet_balance != 0">{{ 'Wallet Credit'
                                                | translate }} <span>-{{ order.wallet_balance | currencySymbol }}</span>
                                            </li>
                                            <li class="txt-primary" *ngIf="order.coupon_total_discount != 0">{{ 'Coupon
                                                Discount' | translate }} <span>-{{ order.coupon_total_discount |
                                                    currencySymbol }}</span></li>

                                            <li>{{ 'Grand Total' | translate }} <span>{{ (order.total ? order.total : 0)
                                                    | currencySymbol }}</span></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 5. Sub-orders (if any) -->
                    <div class="card mt-4" *ngIf="order?.sub_orders?.length">
                        <div class="card-body p-0">
                            <h3 class="fw-semibold p-4 mb-0" style="border-bottom: 1px solid #f1f5f9;">{{ 'Consignment
                                Details' | translate }}</h3>
                            <div class="table-responsive">
                                <table class="table product-table mb-0">
                                    <thead>
                                        <tr>
                                            <th scope="col" class="ps-4">{{ 'Order ID' | translate }}</th>
                                            <th scope="col">{{ 'Date' | translate }}</th>
                                            <th scope="col">{{ 'Total' | translate }}</th>
                                            <th scope="col">{{ 'Status' | translate }}</th>
                                            <th scope="col" class="text-end pe-4">{{ 'View' | translate }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let subOrder of order.sub_orders">
                                            <td class="ps-4">
                                                <h6>#{{ subOrder.order_number }}</h6>
                                            </td>
                                            <td>
                                                <h6>{{ subOrder.created_at | date: 'dd MMM yyyy' }}</h6>
                                            </td>
                                            <td>
                                                <h6>{{ subOrder.amount | currencySymbol }}</h6>
                                            </td>
                                            <td>
                                                <div class="status-{{subOrder.order_status.slug}}">
                                                    <span>{{ subOrder.order_status.name }}</span>
                                                </div>
                                            </td>
                                            <td class="text-end pe-4">
                                                <a href="javascript:void(0)" [routerLink]="['/order/details']"
                                                    [queryParams]="{order_number: subOrder.order_number, email_or_phone: email_or_phone}">
                                                    <i class="ri-eye-line"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <app-no-data [class]="'no-data-added'" [image]="'assets/svg/empty-items.svg'"
                    [text]="'No order details found'" *ngIf="!order">
                </app-no-data>
            </div>
        </div>
    </div>
</section>