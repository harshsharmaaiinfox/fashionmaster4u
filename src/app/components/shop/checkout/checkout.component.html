<section class="checkout-section-2">
    <div class="container-fluid-lg">
        <div class="row g-sm-4 g-3">

            <!-- Main Content Area -->
            <div class="col-xxl-8 col-xl-7">
                <div class="left-sidebar-checkout">

                    <!-- 1. Guest Account Details -->
                    <div class="checkbox-main-box"
                        *ngIf="(setting$ | async)?.activation?.guest_checkout && !(accessToken$ | async)">
                        <div class="checkout-section-title">
                            <div class="step-number">1</div>
                            <h2>{{ 'Account Details' | translate }}</h2>
                        </div>

                        <form [formGroup]="form" class="checkout-form row">
                            <div class="col-md-6">
                                <div class="form-box">
                                    <label>{{ 'Full Name' | translate }}</label>
                                    <input type="text" class="form-control" formControlName="name"
                                        placeholder="{{ 'e.g. John Doe' | translate }}">
                                    <div class="invalid-feedback"
                                        *ngIf="form?.controls?.['name']?.touched && form.controls['name']?.errors?.['required']">
                                        {{ 'Name Is Required' | translate }}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-box">
                                    <label>{{ 'Email Address' | translate }}</label>
                                    <input type="email" class="form-control"
                                        placeholder="{{ 'e.g. john@example.com' | translate }}" formControlName="email">
                                    <div class="invalid-feedback"
                                        *ngIf="form?.controls?.['email']?.touched && (form.controls['email']?.errors?.['required'] || form.controls['email']?.errors?.['email'])">
                                        {{ 'Valid Email is Required' | translate }}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="form-box">
                                    <label>{{ 'Phone Number' | translate }}</label>
                                    <div class="phone-field">
                                        <select2 class="custom-select" [data]="codes" formControlName="country_code"
                                            [templates]="template">
                                            <ng-template #template let-data="data">
                                                <div class="country d-flex align-items-center">
                                                    <span class="iti-flag {{data?.class}} me-2"></span>
                                                    <span>{{data.code}}</span>
                                                </div>
                                            </ng-template>
                                        </select2>
                                        <input type="number" class="form-control" formControlName="phone"
                                            placeholder="{{ '000 000 0000' | translate }}">
                                    </div>
                                    <div class="invalid-feedback"
                                        *ngIf="form?.controls?.['phone']?.touched && form.controls['phone']?.errors?.['required']">
                                        {{ 'Phone is Required' | translate }}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12 mb-3">
                                <div class="form-checkbox">
                                    <input type="checkbox" class="form-check-input" id="account"
                                        formControlName="create_account">
                                    <label class="form-check-label" for="account">{{ 'Create an Account for later?' |
                                        translate }}</label>
                                </div>
                            </div>
                            <div class="col-md-6" *ngIf="form.controls['create_account'].value">
                                <div class="form-box">
                                    <label>{{ 'Set Password' | translate }}</label>
                                    <input type="password" class="form-control" formControlName="password"
                                        placeholder="{{ 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' | translate }}">
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- 2. Shipping Details (Guest) -->
                    <div class="checkbox-main-box"
                        *ngIf="(setting$ | async)?.activation?.guest_checkout && !(accessToken$ | async)">
                        <div class="checkout-section-title">
                            <div class="step-number">2</div>
                            <h2>{{ 'Shipping Destination' | translate }}</h2>
                        </div>

                        <form [formGroup]="form" class="checkout-form">
                            <div class="row" formGroupName="shipping_address">
                                <div class="col-md-12">
                                    <div class="form-box">
                                        <label>{{ 'Address Label' | translate }}</label>
                                        <input type="text" class="form-control" formControlName="title"
                                            placeholder="{{ 'e.g. Home, Office' | translate }}">
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-box">
                                        <label>{{ 'Street Address' | translate }}</label>
                                        <input type="text" class="form-control" formControlName="street"
                                            placeholder="{{ 'House No, Building Name, Street' | translate }}">
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-box">
                                        <label>{{ 'Country' | translate }}</label>
                                        <select2 class="custom-select" [data]="(countries$ | async) || []"
                                            [placeholder]="'Select Country' | translate"
                                            (update)="shippingCountryChange($event)" formControlName="country_id"
                                            resettable></select2>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-box">
                                        <label>{{ 'State' | translate }}</label>
                                        <select2 class="custom-select" [data]="(shippingStates$ | async) || []"
                                            [placeholder]="'Select State' | translate" formControlName="state_id">
                                        </select2>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-box">
                                        <label>{{ 'City' | translate }}</label>
                                        <input type="text" class="form-control" formControlName="city"
                                            placeholder="{{ 'City Name' | translate }}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-box">
                                        <label>{{ 'Phone for Shipping' | translate }}</label>
                                        <input type="number" class="form-control" formControlName="phone"
                                            placeholder="{{ 'Phone' | translate }}">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Logged In User Sections -->
                    <div class="checkout-detail-box" *ngIf="(accessToken$ | async)">
                        <ul>
                            <!-- Shipping Address -->
                            <li *ngIf="!(cartDigital$ | async)">
                                <div class="checkout-title">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="step-number">1</div>
                                        <h4>{{ 'Shipping Address' | translate }}</h4>
                                    </div>
                                    <a href="javascript:void(0)" (click)="AddressModal.openModal()">+ {{ 'Add New' |
                                        translate }}</a>
                                </div>
                                <div class="checkout-detail">
                                    <app-address-block [addresses]="(user$ | async)?.address" [type]="'shipping'"
                                        (selectAddress)="selectShippingAddress($event)"></app-address-block>
                                </div>
                            </li>

                            <!-- Billing Address -->
                            <li>
                                <div class="checkout-title">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="step-number">2</div>
                                        <h4>{{ 'Billing Address' | translate }}</h4>
                                    </div>
                                    <a href="javascript:void(0)" (click)="AddressModal.openModal()">+ {{ 'Add New' |
                                        translate }}</a>
                                </div>
                                <div class="checkout-detail">
                                    <app-address-block [addresses]="(user$ | async)?.address" [type]="'billing'"
                                        (selectAddress)="selectBillingAddress($event)"></app-address-block>
                                </div>
                            </li>

                            <!-- Delivery Options -->
                            <li *ngIf="!(cartDigital$ | async)">
                                <div class="checkout-title">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="step-number">3</div>
                                        <h4>{{ 'Delivery Options' | translate }}</h4>
                                    </div>
                                </div>
                                <app-delivery-block [setting]="(setting$ | async)!"
                                    (selectDelivery)="selectDelivery($event)"></app-delivery-block>
                            </li>
                        </ul>
                    </div>

                    <!-- Payment (Common for both) -->
                    <div class="payment-options-card">
                        <div class="checkout-section-title mb-4">
                            <h2><i class="ri-bank-card-line"></i> {{ 'Payment Method' | translate }}</h2>
                        </div>
                        <app-payment-block [setting]="(setting$ | async)!"
                            (selectPaymentMethod)="selectPaymentMethod($event)"></app-payment-block>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar: Order Summary -->
            <div class="col-xxl-4 col-xl-5">
                <div class="checkout-summary-card">
                    <div class="title-header">
                        <h5>{{ 'Order Summary' | translate }}</h5>
                    </div>

                    <!-- Items List -->
                    <div class="product-details mb-4">
                        <app-no-data [class]="'empty-cart'" [text]="'No Items Cart'"
                            *ngIf="!(cartItem$ | async)?.length && !localCartItems.length"></app-no-data>
                        <ul class="cart-listing" *ngIf="(cartItem$ | async)?.length || localCartItems.length">
                            <li *ngFor="let item of (cartItem$ | async)?.length ? (cartItem$ | async) : localCartItems">
                                <img [src]="item?.variation && item?.variation?.variation_image ? item?.variation?.variation_image?.original_url : item?.product?.product_thumbnail ? item?.product?.product_thumbnail?.original_url : 'assets/images/product.png'"
                                    alt="product">
                                <div class="cart-content">
                                    <h4>{{ item?.variation ? item?.variation?.name : item?.product?.name }}</h4>
                                    <p class="text-theme">{{ ((item?.variation ? item.variation.sale_price :
                                        (item?.product && item?.wholesale_price ? item.wholesale_price :
                                        item?.product?.sale_price)) || 0) | currencySymbol }} Ã— {{ item.quantity }}</p>
                                    <h5 class="price">{{ (((item?.variation ? item.variation.sale_price : (item?.product
                                        && item?.wholesale_price ? item.wholesale_price : item?.product?.sale_price)) ||
                                        0) * (item.quantity || 0)) | currencySymbol }}</h5>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <form [formGroup]="form" (ngSubmit)="placeorder()">
                        <div class="custom-box-loader">
                            <div class="box-loader" *ngIf="loading">
                                <app-loader [loaderClass]="'custom-loader-wrapper blur-bg'"></app-loader>
                            </div>

                            <ul class="summary-total">
                                <li>
                                    <h4>{{ 'Subtotal' | translate }}</h4>
                                    <h4 class="price">{{ (checkoutTotal ? (checkoutTotal.total.sub_total || 0) :
                                        (subTotal || 0)) | currencySymbol }}</h4>
                                </li>
                                <li *ngIf="!(cartDigital$ | async)">
                                    <h4>{{ 'Shipping' | translate }}</h4>
                                    <h4 class="price">{{ (checkoutTotal ? (checkoutTotal.total.shipping_total || 0) :
                                        (0)) | currencySymbol }}</h4>
                                </li>
                                <li>
                                    <h4>{{ 'Tax' | translate }}</h4>
                                    <h4 class="price">{{ (checkoutTotal ? (checkoutTotal.total.tax_total || 0) : (0)) |
                                        currencySymbol }}</h4>
                                </li>

                                <!-- Points & Wallet (Logged In) -->
                                <ng-container *ngIf="(user$ | async) && checkoutTotal">
                                    <li *ngIf="(user$ | async)?.point?.balance">
                                        <h4 [class.text-dark]="form.controls['points_amount'].value">{{ 'Points' |
                                            translate }}</h4>
                                        <h4 class="price">{{ (checkoutTotal.total.convert_point_amount || 0) |
                                            currencySymbol }}</h4>
                                    </li>
                                    <li class="border-cls" *ngIf="(user$ | async)?.point?.balance">
                                        <label class="form-check-label">{{ 'Use Reward Points' | translate }}</label>
                                        <input class="checkbox_animated" type="checkbox" (change)="togglePoint($event)">
                                    </li>

                                    <li *ngIf="(user$ | async)?.wallet?.balance">
                                        <h4 [class.text-dark]="form.controls['wallet_balance'].value">{{ 'Wallet
                                            Balance' | translate }}</h4>
                                        <h4 class="price">{{ (checkoutTotal.total.convert_wallet_balance || 0) |
                                            currencySymbol }}</h4>
                                    </li>
                                    <li class="border-cls" *ngIf="(user$ | async)?.wallet?.balance">
                                        <label class="form-check-label">{{ 'Use Wallet Balance' | translate }}</label>
                                        <input class="checkbox_animated" type="checkbox"
                                            (change)="toggleWallet($event)">
                                    </li>
                                </ng-container>

                                <!-- Coupon Section -->
                                <li class="coupon-sec" *ngIf="checkoutTotal">
                                    <a class="promocode-title" (click)="showCoupon()" *ngIf="!coupon && !appliedCoupon">
                                        <h4>{{ 'Have a Promo Code?' | translate }}</h4>
                                    </a>
                                    <div class="coupon-box" *ngIf="coupon && !appliedCoupon">
                                        <div class="input-group">
                                            <input type="text" #cpn placeholder="{{ 'Code' | translate }}">
                                            <button type="button" class="btn-apply"
                                                (click)="cpn.value && setCoupon(cpn.value)">
                                                {{ 'Apply' | translate }}
                                            </button>
                                        </div>
                                        <div class="invalid-feedback d-block mt-2" *ngIf="couponError">{{ couponError }}
                                        </div>
                                    </div>
                                    <div class="apply-sec mt-3" *ngIf="appliedCoupon">
                                        <div>
                                            <h4 class="m-0">ðŸŽ‰ {{ 'Saved' | translate }} <span>{{
                                                    (checkoutTotal.total.coupon_total_discount || 0) | currencySymbol
                                                    }}</span></h4>
                                        </div>
                                        <a href="javascript:void(0)" (click)="couponRemove()">{{ 'Remove' | translate
                                            }}</a>
                                    </div>
                                </li>

                                <!-- Grand Total -->
                                <li class="list-total">
                                    <h4>{{ 'Total Total' | translate }}</h4>
                                    <h4 class="price">{{ (checkoutTotal ? (checkoutTotal.total.total || 0) :
                                        (subTotal || 0)) | currencySymbol }}</h4>
                                </li>
                            </ul>

                            <button type="submit" class="btn theme-bg-color mt-4"
                                [disabled]="loading || !(form.valid && checkoutTotal)">
                                {{ 'Confirm Order' | translate }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<address-modal #AddressModal></address-modal>
<div id="paymentContainer" style="visibility: hidden;"></div>

<!-- Pay By QR Modal Template -->
<ng-template #payByQRModal let-data="data">
    <div class="dashboard-address p-4">
        <div class="text-center mb-4">
            <h5 class="fw-bold">{{ 'Scan to Pay' | translate }}</h5>
        </div>
        <div class="qr-container text-center p-3 bg-white border rounded">
            <img src="assets/images/QR_Code.png" alt="QR Code" class="img-fluid" style="max-height: 250px;">
        </div>
        <div class="text-center mt-3 upi-id bg-light p-2 rounded fw-bold">9643790758&#64;YESBANK</div>
        <p class="text-muted text-center mt-3 small">
            {{ 'Scan with GPay, PhonePe, or Paytm. Enter Transaction ID on next screen.' | translate }}
        </p>
        <div class="d-grid mt-4">
            <button type="button" class="btn btn-dark py-3" (click)="paybyNeoNext()">{{ 'Next' | translate }}</button>
        </div>
    </div>
</ng-template>