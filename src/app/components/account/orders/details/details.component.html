<div class="tab-pane fade show active">
    <div class="dashboard-home">
        <!-- 1. Global Account Navigation (Sticky) -->
        <div class="dashboard-menu-bar">
            <div class="menu-container">
                <a class="menu-item" [routerLinkActive]="['active']" [routerLink]="['/account/dashboard']">
                    <i class="ri-dashboard-line"></i>
                    <span>{{ 'Dashboard' | translate }}</span>
                </a>
                <a class="menu-item" [routerLinkActive]="['active']" [routerLink]="['/account/order']">
                    <i class="ri-shopping-bag-3-line"></i>
                    <span>{{ 'My Orders' | translate }}</span>
                </a>
                <a class="menu-item" [routerLinkActive]="['active']" [routerLink]="['/account/addresses']">
                    <i class="ri-map-pin-2-line"></i>
                    <span>{{ 'Addresses' | translate }}</span>
                </a>
                <a class="menu-item" [routerLinkActive]="['active']" [routerLink]="['/account/bank-details']">
                    <i class="ri-bank-line"></i>
                    <span>{{ 'Finances' | translate }}</span>
                </a>
            </div>
        </div>

        <!-- 2. Dashboard Header -->
        <div class="dashboard-header">
            <h2 class="dashboard-title">{{ 'Order Details' | translate }}</h2>
            <p class="dashboard-subtitle">{{ 'Detailed information for order' | translate }} <strong>#{{
                    order?.order_number }}</strong></p>
        </div>

        <!-- 3. Order Actions & Branding -->
        <div class="dashboard-content order-details-wrapper" *ngIf="order">
            <div class="order-header-card">
                <div class="order-info">
                    <h2 class="order-number">#{{ order.order_number }}</h2>
                    <span class="order-date">{{ order.created_at | date: 'dd MMMM yyyy' }}</span>
                </div>
                <div class="order-actions">
                    <a href="javascript:void(0)" class="btn-pay"
                        *ngIf="(order?.payment_status === 'FAILED' || order?.payment_status === 'PENDING') 
                        && (order?.order_status && order?.order_status?.slug != 'cancelled') && order?.payment_method != 'cod'"
                        (click)="payModal.openModal(order)">
                        <i class="ri-wallet-3-line"></i>
                        {{ 'Pay Now' | translate }}
                    </a>
                    <a (click)="download(order.order_number)" class="btn-invoice"
                        *ngIf="order?.invoice_url && order?.payment_status && order?.payment_status === 'COMPLETED' && isLogin">
                        <i class="ri-download-cloud-2-line"></i>
                        {{ 'Invoice' | translate }}
                    </a>
                </div>
            </div>

            <!-- 4. Tracking Sequence -->
            <div class="tracking-card">
                <div class="tracking-panel">
                    <ul *ngIf="order && !order?.sub_orders?.length">
                        <ng-container *ngFor="let orderStatus of (orderStatus$ | async)?.data">
                            <li [class.active]="orderStatus?.sequence! <= order.order_status.sequence!" [ngClass]="{
                                    'd-none': (orderStatus?.sequence! >= order.order_status.sequence! 
                                    && (order.order_status && order.order_status.slug == 'cancelled')) ||
                                    orderStatus?.slug == 'cancelled' || (order.is_digital_only && (orderStatus?.slug == 'shipped' || orderStatus?.slug == 'out-for-delivery'))
                                }">
                                <div class="panel-content">
                                    <div class="icon">
                                        <img src="assets/svg/tracking/{{orderStatus?.slug}}.svg" class="img-fluid"
                                            alt="tracking">
                                    </div>
                                    <div class="status">{{ orderStatus?.name?.replaceAll('_', ' ') | titlecase }}</div>
                                </div>
                            </li>
                        </ng-container>
                        <li class="active cancelled-box"
                            *ngIf="order?.order_status && order?.order_status?.slug == 'cancelled'">
                            <div class="panel-content">
                                <div class="icon" style="background: #fee2e2;">
                                    <img src="assets/svg/tracking/{{order.order_status.slug}}.svg" class="img-fluid"
                                        alt="cancelled">
                                </div>
                                <div class="status" style="color: #ef4444;">{{ order.order_status.name.replace('_', '
                                    ')! | titlecase }}</div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- 5. Product Catalog Table -->
            <div class="products-card" *ngIf="order?.products?.length">
                <div class="table-responsive">
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>{{ 'Item' | translate }}</th>
                                <th>{{ 'Description' | translate }}</th>
                                <th>{{ 'Price' | translate }}</th>
                                <th>{{ 'Qty' | translate }}</th>
                                <th>{{ 'Subtotal' | translate }}</th>
                                <th class="text-end pe-4">{{ 'Returns' | translate }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let product of order.products">
                                <td class="product-image">
                                    <img [src]="product?.pivot?.variation && product?.pivot?.variation?.variation_image
                                            ? product?.pivot?.variation?.variation_image?.original_url
                                            : product?.product_thumbnail
                                            ? product?.product_thumbnail?.original_url
                                            : 'assets/images/product.png'" class="img-fluid" alt="product">
                                </td>
                                <td>
                                    <h6>{{ product?.pivot?.variation ? product?.pivot?.variation?.name : product?.name
                                        }}</h6>
                                </td>
                                <td>
                                    <h6>{{ product?.pivot?.single_price | currencySymbol }}</h6>
                                </td>
                                <td>
                                    <h6>{{ product?.pivot?.quantity }}</h6>
                                </td>
                                <td>
                                    <h6>{{ product?.pivot?.subtotal | currencySymbol }}</h6>
                                </td>
                                <td class="text-end pe-4">
                                    <a class="btn-refund" href="javascript:void(0)" *ngIf="product?.is_return === 1 &&
                                        order?.payment_status && order?.payment_status === 'COMPLETED' 
                                        && order.order_status && order.order_status.slug == 'delivered' && 
                                        !product?.pivot?.refund_status;
                                        else noRefund" (click)="refundModal.openModal(product, order.id)">
                                        {{ 'Initiate Refund' | translate }}
                                    </a>
                                    <ng-template #noRefund>
                                        <ng-container *ngIf="product.is_return === 0; else NonRefundable">
                                            <span class="text-muted"
                                                style="font-size: 11px; font-weight: 700; text-transform: uppercase;">Non-Returnable</span>
                                        </ng-container>
                                        <ng-template #NonRefundable>
                                            <div class="status-badge status-{{product?.pivot?.refund_status?.toLowerCase()}}"
                                                *ngIf="product?.pivot?.refund_status; else disabled">
                                                <span>{{ product?.pivot?.refund_status | titleCase }}</span>
                                            </div>
                                            <ng-template #disabled>
                                                <div placement="top" ngbTooltip="Enable after delivery">
                                                    <a class="btn-refund disabled"
                                                        *ngIf="!product?.pivot?.refund_status"> {{ 'Refund' | translate
                                                        }}</a>
                                                </div>
                                            </ng-template>
                                        </ng-template>
                                    </ng-template>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 6. Details Grid -->
            <div class="row g-4">
                <div class="col-xxl-8 col-lg-7">
                    <div class="details-card h-100">
                        <div class="card-header">
                            <h4 class="card-title">
                                <i class="ri-user-heart-line"></i>
                                {{ 'Consumer Information' | translate }}
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="details-grid">
                                <!-- 1. Client Details -->
                                <div class="detail-item">
                                    <label>{{ 'Client Details' | translate }}</label>
                                    <div class="detail-value">
                                        <span class="fw-bold">{{ order.consumer_name ? order.consumer_name :
                                            order.consumer?.name }}</span><br>
                                        <span class="contact">{{ (order.consumer?.email ? order.consumer?.email :
                                            order.guest_order?.email) }}</span>
                                    </div>
                                </div>

                                <!-- 2. Billing Address -->
                                <div class="detail-item" *ngIf="order?.billing_address">
                                    <label>{{ 'Billing Address' | translate }}</label>
                                    <div class="detail-value">
                                        {{ order.billing_address.street }}<br>
                                        {{ order.billing_address.city }}<span *ngIf="order.billing_address.state">, {{
                                            order.billing_address.state.name }}</span><br>
                                        {{ order.billing_address.country.name }} - {{ order.billing_address.pincode
                                        }}<br>
                                        <span class="contact">{{ order.billing_address.country_code }} {{
                                            order.billing_address.phone }}</span>
                                    </div>
                                </div>

                                <!-- 3. Shipping Address -->
                                <div class="detail-item" *ngIf="order?.shipping_address && !order?.is_digital_only">
                                    <label>{{ 'Shipping Address' | translate }}</label>
                                    <div class="detail-value">
                                        {{ order.shipping_address.street }}<br>
                                        {{ order.shipping_address.city }}<span *ngIf="order.shipping_address.state">, {{
                                            order.shipping_address.state.name }}</span><br>
                                        {{ order.shipping_address.country.name }} - {{ order.shipping_address.pincode
                                        }}<br>
                                        <span class="contact">{{ order.shipping_address.country_code }} {{
                                            order.shipping_address.phone }}</span>
                                    </div>
                                </div>

                                <!-- 4. Method & Status -->
                                <div class="detail-item">
                                    <label>{{ 'Method & Status' | translate }}</label>
                                    <div class="detail-value">
                                        <div class="mb-2">
                                            <strong>{{ 'Payment' | translate }}:</strong>
                                            {{ (order?.payment_method === 'RaylomShop_nabu' ? 'UPI Online' :
                                            order.payment_method) | uppercase }}
                                        </div>
                                        <div>
                                            <strong>{{ 'Status' | translate }}:</strong>
                                            <span class="status-badge status-{{order.payment_status?.toLowerCase()}}">
                                                {{ order.payment_status | uppercase }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Summary Card -->
                <div class="col-xxl-4 col-lg-5">
                    <div class="summary-card h-100">
                        <div class="card-header">
                            <h4 class="card-title">
                                <i class="ri-file-list-3-line"></i>
                                {{ 'Order Summary' | translate }}
                            </h4>
                        </div>
                        <div class="card-body">
                            <ul class="summary-list">
                                <li>{{ 'Subtotal' | translate }} <span>{{ (order.amount ? order.amount : 0) |
                                        currencySymbol }}</span></li>
                                <li *ngIf="!order?.is_digital_only">{{ 'Shipping'| translate }} <span>{{
                                        (order.shipping_total ? order.shipping_total : 0) | currencySymbol }}</span>
                                </li>
                                <li>{{ 'Tax'| translate }} <span>{{ (order.tax_total ? order.tax_total : 0) |
                                        currencySymbol }}</span></li>
                                <li class="discount" *ngIf="order.points_amount != 0">{{ 'Points Used'| translate }}
                                    <span>-{{ order.points_amount | currencySymbol }}</span>
                                </li>
                                <li class="discount" *ngIf="order.wallet_balance != 0">{{ 'Wallet Credit'| translate }}
                                    <span>-{{ order.wallet_balance | currencySymbol }}</span>
                                </li>
                                <li class="discount" *ngIf="order.coupon_total_discount != 0">{{ 'Coupon'| translate }}
                                    <span>-{{ order.coupon_total_discount | currencySymbol }}</span>
                                </li>
                                <li class="total">{{ 'Grand Total'| translate }} <span>{{ (order.total ? order.total :
                                        0) | currencySymbol }}</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 7. Consignments Sections -->
            <div class="products-card mt-4" *ngIf="order?.sub_orders?.length">
                <div class="card-header p-4" style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                    <h4 class="card-title"
                        style="font-size: 16px; font-weight: 800; text-transform: uppercase; margin: 0;">{{ 'Consignment
                        Details' | translate }}</h4>
                </div>
                <div class="table-responsive">
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>{{ 'Order ID' | translate }}</th>
                                <th>{{ 'Date' | translate }}</th>
                                <th>{{ 'Total' | translate }}</th>
                                <th>{{ 'Status' | translate }}</th>
                                <th class="text-end pe-4">{{ 'View' | translate }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let subOrder of order.sub_orders">
                                <td>
                                    <h6>#{{ subOrder.order_number }}</h6>
                                </td>
                                <td>
                                    <h6>{{ subOrder.created_at | date: 'dd MMM yyyy' }}</h6>
                                </td>
                                <td>
                                    <h6>{{ subOrder.amount | currencySymbol }}</h6>
                                </td>
                                <td>
                                    <div class="status-badge status-{{subOrder.order_status.slug}}">
                                        <span>{{ subOrder.order_status.name }}</span>
                                    </div>
                                </td>
                                <td class="text-end pe-4">
                                    <a href="javascript:void(0)" class="view-btn"
                                        [routerLink]="['/account/order/details', subOrder.order_number]">
                                        <i class="ri-eye-line"></i>
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<app-refund-modal #refundModal></app-refund-modal>
<app-pay-modal #payModal></app-pay-modal>